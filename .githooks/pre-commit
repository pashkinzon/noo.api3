#!/usr/bin/env bash
set -euo pipefail

# Ensure dotnet is available
if ! command -v dotnet >/dev/null 2>&1; then
  echo "[pre-commit] dotnet not found in PATH" >&2
  exit 1
fi

# Check code formatting
echo "[pre-commit] Running dotnet format..."
dotnet format
echo "[pre-commit] Verifying everything is formatted..."
dotnet format --verify-no-changes
if [ $? -ne 0 ]; then
  echo "Code is not formatted. Running formatter..."
  dotnet format
  echo "Files have been formatted. Please stage the changes and commit again."
  exit 1
fi

echo "[pre-commit] Building solution..."
# Build the main API project fast (Release to match CI, no restore overhead due to implicit restore)
if ! dotnet build ./src/Noo.Api/Noo.Api.csproj -c Release -clp:ErrorsOnly >/dev/null; then
  echo "[pre-commit] Build failed. Commit aborted." >&2
  exit 1
fi

# If tests project exists, run unit tests quickly
if [ -f ./tests/Noo.UnitTests/Noo.UnitTests.csproj ]; then
  echo "[pre-commit] Running unit tests..."
  if ! dotnet test ./tests/Noo.UnitTests/Noo.UnitTests.csproj -c Release --no-build --verbosity minimal >/dev/null; then
    echo "[pre-commit] Unit tests failed. Commit aborted." >&2
    exit 1
  fi
fi

# If integration tests project exists, run them too
if [ -f ./tests/Noo.IntegrationTests/Noo.IntegrationTests.csproj ]; then
  echo "[pre-commit] Running integration tests..."
  if ! dotnet test ./tests/Noo.IntegrationTests/Noo.IntegrationTests.csproj -c Release --no-build --verbosity minimal >/dev/null; then
    echo "[pre-commit] Integration tests failed. Commit aborted." >&2
    exit 1
  fi
fi

echo "[pre-commit] All checks passed."
