#!/usr/bin/env bash
set -euo pipefail

# Prevent push if build or tests fail
if ! command -v dotnet >/dev/null 2>&1; then
  echo "[pre-push] dotnet not found in PATH" >&2
  exit 1
fi

echo "[pre-push] Restoring and building..."
dotnet restore ./noo.api.sln >/dev/null
if ! dotnet build ./src/Noo.Api/Noo.Api.csproj -c Release -clp:ErrorsOnly >/dev/null; then
  echo "[pre-push] Build failed. Push aborted." >&2
  exit 1
fi

echo "[pre-push] Running unit tests..."
if [ -f ./tests/Noo.UnitTests/Noo.UnitTests.csproj ]; then
  if ! dotnet test ./tests/Noo.UnitTests/Noo.UnitTests.csproj -c Release --no-build --verbosity minimal >/dev/null; then
    echo "[pre-push] Unit tests failed. Push aborted." >&2
    exit 1
  fi
fi

echo "[pre-push] Running integration tests..."
if [ -f ./tests/Noo.IntegrationTests/Noo.IntegrationTests.csproj ]; then
  if ! dotnet test ./tests/Noo.IntegrationTests/Noo.IntegrationTests.csproj -c Release --no-build --verbosity minimal >/dev/null; then
    echo "[pre-push] Integration tests failed. Push aborted." >&2
    exit 1
  fi
fi

echo "[pre-push] All checks passed."
